<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odin Book</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>

      <nav id="dashboard">
           
        <h1>Mesh Book</h1>
          <% if (user) { %>
          <div style="display: flex; align-items: center;">
            <img src="/uploads/walls.png" alt="Default Profile Picture" style="margin-right: 10px; width: 30px; height: 30px; border-radius: 50px;">
            <h1>Welcome, <%= user.username %></h1>
            </div>
            <% if (user.profile && user.profile.image) { %>
              <img src="/uploads/<%= user.profile.image %>" alt="Profile Picture" style="width: 30px; height: 30px; border-radius: 50px;">
            <% } else { %>
              <% } %>
          <% } else { %>
            <p>User</p>
          <% } %>
            <

          
            <!-- navbar.ejs -->

    <ul>
      <li><a href="/" class="nav-link <%= path === '/' ? 'active' : '' %>"><i class="fa fa-home"></i>Home</a></li>
      <br>
      <li><a href="/about" class="nav-link <%= path === '/about' ? 'active' : '' %>"><i class="fa fa-user-friends"></i>Friends</a></li>
      <br>
      <li><a href="/contact" class="nav-link <%= path === '/contact' ? 'active' : '' %>"><i class="fa fa-user-cog"></i>Account</a></li>
    </ul>
</nav>

        
        <div class="container">
        <section class="board" id="following">
            <a href="">Following</a>
        </section>
        
        <section class="board" id="createpost">
            <form enctype="multipart/form-data" action="/posts" method="post">
                <label for="">What is the Update?</label>
                <input type="file" name="postImage" accept="image/*">
                <label for="content">Content</label>
                <input type="text" id="content" name="content" required>
                <button type="submit">Post</button>
            </form>
        </section>
        <section class="board" id="showpost">
            <a href="/posts">Show All posts</a>
        </section>
        
        <section class="board" id="pictures">
            <% if (profiles && profiles.length > 0) { %>
                <% profiles.forEach((profile) => { %>
                    <a href="/profiles/<%= profile.id %>">
                        <% if (profile) { %>
                          <% if (profile.image) { %>
                            <div style="display: flex; align-items: center;">
                                  <img src="/uploads/<%= profile.image %>" alt="Profile Picture" style="width: 50px; height: 50px; border-radius: 50px;">
                                <p style="margin-left: 10px;"><%= profile.user.username %></p>
                                <button type="submit" style="margin-left: 330px;">Follow</button>
                              </div>
                              
                              <% if (profile.user.posts && profile.user.posts.length > 0) { %>
                              <% profile.user.posts.forEach((post) => { %>  
                                <div>
                                    <% if (post.image) { %>
                                        <img src="/uploads/<%= post.image %>" alt="Post Image" style="width: 500px; height: 500px;">
                                        <% } %>
                                        <p><%= post.content %></p>
                                        <p>Likes: <%= post._count.likes %></p>
                                        <p style="color: white;">Comments: <%= post._count.comments %></p>
                                        <a href=""><i class="fa fa-comment"></i></a>
                                        <a href=""><i class="fa fa-bookmark"></i></a>
                                        <a href=""><i class="fa fa-send"></i></a>
                                    </div>
                                    <% if (user && post.userId === user.id) { %>
                                        <form action="/home/delete/<%= post.id %>" method="post">
                                          <button type="submit">Delete Post</button>
                                        </form>
                                    <% } %>

                                       <!-- like button -->
                                        <button class="like-btn" data-post-id="<%= post.id %>">
                                            <i class="fa fa-heart"></i><span class="like-count"><%= post.likeCount %></span>
                                        </button>

                                          
                                      

                                        <form action="/home/<%= post.id %>/comments" method="post">
                                        <input type="hidden" name="postId" value="<%= post.id %>">
                                        <textarea name="content" placeholder="Write a comment..."></textarea>
                                        <br>
                                        <button type="submit">Submit</button>
                                        </form>
                                      
                                      <!-- Display comments -->

                                      <% if (post.comments && post.comments.length > 0) { %>
                                        <% post.comments.forEach((comment) => { %>
                                            <% console.log(comment); %>

                                          <div>
                                            <% if (comment.user) { %>
                                              <p style="color: yellow;"><%= comment.user.username%>: <%= comment.content %></p>
                                            <% } else { %>
                                              <p>Unknown user : <%= comment.content %></p>
                                            <% } %>
                                          </div>
                                        <% }); %>
                                      <% } %>
                                      <% console.log(post); %>

                                  
                                    <% }); %>
                                    <% } else { %>
                                        <p>No posts available</p>
                                        <% } %>
                                        <div style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px;"></div>

                                        <% } else { %>
                                            <p>No profile picture available</p>
                                            <% } %>
                                            <% } else { %>
                                                <p>No profile information available</p>
                                                <% } %>
                                            </a>
                                            <% }); %>
                                            <% } %>

                                            
        </section>
        
        
        
        <div class="search-container">
            <input type="search" id="search-input" placeholder="Search...">
            <button type="submit" id="search-button">
                <i class="fa fa-search"></i>
            </button> 
        </div>
    </div>

    <script>


document.body.addEventListener('click', async (event) => {
  if (event.target.classList.contains('like-btn') || event.target.classList.contains('unlike-btn')) {
    const btn = event.target;
    const postId = btn.dataset.postId;
    const isLiked = btn.classList.contains('like-btn');
    try {
      const response = await fetch(`/posts/${postId}/${isLiked ? 'like' : 'unlike'}`, {
        method: isLiked ? 'POST' : 'DELETE',
        headers: { 'Content-Type': 'application/json' },
      });
      const data = await response.json();
      btn.classList.toggle('like-btn');
      btn.classList.toggle('unlike-btn');
      btn.innerHTML = `${isLiked ? 'Unlike' : 'Like'} (${data.likes})`;
      console.log(data);
    } catch (error) {
      console.error(error);
    }
  }
});


      </script>
</body>
</html>